---
layout: post
title:  iptables autostart
date:   2020/02/05 12:24:23
tag:    server ubuntu
---


iptables
как настроить автозагрузку правил...
https://qna.habr.com/q/34551
предлагает несколько вариантов:
1. /etc/network/interfaces
Пример:
В /etc/rc.local:

F="/etc/network/iptables.save"
test -f "$F" && /sbin/iptables-restore < $F

2. iptables-persistent

  # service iptables-persistent
  Usage: /etc/init.d/iptables-persistent {start|restart|reload|force-reload|save|flush}

после настройки правил как нужно, сделать 
# service iptables-persistent save 
и при следующей загрузке они будут применены

3. bash/sh файл в rc.local или init.d
...

2 и 3 вариант не очень "минималистичен"...
1. 
- настроил iptables
- sudo iptables-save > /etc/iptables.my
- в /etc/network/interfaces дописал
post-up iptables-restore < /etc/iptables.my

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
Вроде все понятно, но не сработало!?
После перезагрузки нет того, что в /etc/iptables.my
а есть вот такое

  ..,
  -A FORWARD -o ppp0 -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1400:65495 -j TCPMSS --clamp-mss-to-pmtu
  -A FORWARD -o ppp0 -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1400:65495 -j TCPMSS --clamp-mss-to-pmtu
  ...

почему-то две одинаковых строки!?
откуда? Попробовал разобраться

поискал по строке
tcpmss --mss 1400:65495 -j TCPMSS --clamp-mss-to-pmtu

  ┌─────────────────────── Поиск файла ────────────────────────┐
  │ /etc                                                       │
  │     26:iptables.my                                         │
  │     17:iptables.up.rules                                   │
  │     17:iptables.my.20200205                                │
  │ /etc/iptables                                              │
  │     8:rules.v4                                             │
  │ /etc/ppp/ip-up.d                                           │
  │     4:0clampmss       

iptables.my* и iptables.up.rules - мои настройки полученные
после настройки и запуска iptables-save

cat /etc/iptables/rules.v4

  # Generated by iptables-save v1.6.0 on Wed Jun 28 12:13:12 2017
  ...
  -A FORWARD -o ppp0 -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss ...
  ...
  -A POSTROUTING -o ppp0 -j MASQUERADE
  ...

похоже это первая "пачка" правил

> cat /etc/ppp/ip-up.d/0clampmss

  ...
  !/bin/sh
  # Enable MSS clamping (autogenerated by pppoeconf)
  
  iptables -t mangle -o "$PPP_IFACE" --insert FORWARD 1 -p tcp --tcp-flags SYN,RST
  ...

а вот и вторая "пачка"!

!!! Получается 2-я пачка сгенерирована pppoeconf !!!
Закоментировал дублирующая строка пропала!!!

? Кто сгенерировал 1-ю пачку?
https://www.8host.com/blog/bazovye-pravila-iptables-dlya-servera-ubuntu-14-04/
...
Пакет iptables-persistent записывает правила IPv4 в /etc/iptables/rules.v4, а правила IPv6 – в /etc/iptables/rules.v6.
...

> # dpkg -l | grep persist

  ii  iptables-persistent                 1.0.4                                      all          boot-time loader for netfilter rules, iptables plugin
  ii  netfilter-persistent                1.0.4                                      all          boot-time loader for netfilter configuration
  

а вот команду не нашел, зато нашел
iptables-apply
изучи позже...

Сделал так - результат iptables-save сохранил в 
/etc/iptables/rules.v4
ребут - все ок!

PS. Может нужно было просто установить iptables-persistent еще раз!?
Исправления редки, поэтому так пойдет...
